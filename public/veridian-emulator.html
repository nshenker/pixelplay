<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Veridian Emulator Core</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #9bbc0f; }
        canvas { width: 100%; height: 100%; image-rendering: pixelated; image-rendering: crisp-edges; }
    </style>
</head>
<body>
    <canvas id="game-canvas" width="160" height="144"></canvas>

    <script src="https://unpkg.com/gameboycore/dist/gameboycore.min.js"></script>
    <script>
        // --- The API for our React component to use ---
        window.VeridianAPI = {
            gameboy: null,
            canvas: null,

            // Initializes the emulator
            init: function() {
                this.canvas = document.getElementById('game-canvas');
                this.gameboy = new GameBoyCore(this.canvas);
                this.gameboy.start();
                console.log("Veridian Emulator Core Initialized.");
            },
            
            // Loads a ROM provided as a Base64 string
            loadRom: function(base64Rom) {
                if (!this.gameboy) {
                    console.error("Emulator not initialized.");
                    return;
                }
                try {
                    // Decode the Base64 string into binary data
                    const binaryString = window.atob(base64Rom);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    this.gameboy.loadRom(bytes);
                    console.log("ROM loaded successfully.");
                } catch (e) {
                    console.error("Failed to load ROM:", e);
                }
            },
            
            // Functions to handle button presses from the parent component
            press: function(key) {
                if (!this.gameboy) return;
                this.gameboy.joypad.keyDown(this.keyMap(key));
            },

            release: function(key) {
                if (!this.gameboy) return;
                this.gameboy.joypad.keyUp(this.keyMap(key));
            },

            // Maps our simple button names to the emulator's key codes
            keyMap: function(key) {
                switch(key) {
                    case 'A': return GameBoyCore.JoyPad.A;
                    case 'B': return GameBoyCore.JoyPad.B;
                    case 'START': return GameBoyCore.JoyPad.START;
                    case 'SELECT': return GameBoyCore.JoyPad.SELECT;
                    case 'UP': return GameBoyCore.JoyPad.UP;
                    case 'DOWN': return GameBoyCore.JoyPad.DOWN;
                    case 'LEFT': return GameBoyCore.JoyPad.LEFT;
                    case 'RIGHT': return GameBoyCore.JoyPad.RIGHT;
                    default: return null;
                }
            }
        };
        
        // Initialize the emulator as soon as the page loads
        window.VeridianAPI.init();

    </script>
</body>
</html>
